---
// Projects.astro

// 1. RECUPERAMOS LOS DATOS
const { blok } = Astro.props;
const propsProjects = Astro.props.projects;

// Prioridad: 1. blok.items (Storyblok) | 2. props.projects (Fallback) | 3. Array vacío
const projects = blok?.items || propsProjects || [];

// CONFIGURACIÓN: Datos sale primero
const DEFAULT_FILTER = "datos"; 
---

<section id="proyectos" class="py-20 bg-[#030712] text-white">
  <div class="container mx-auto px-4">
    
    <div class="text-center mb-16">
      <span class="bg-slate-800 text-blue-200 px-4 py-1.5 rounded-full text-xs font-bold tracking-wide uppercase border border-slate-700">
        Portfolio
      </span>
      <h2 class="text-4xl md:text-5xl font-bold mt-6 mb-4 bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">
        {/* AQUÍ EL CAMBIO: Título dinámico */}
        {blok?.title || "Proyectos"}
      </h2>
      
      <p class="text-slate-400 text-lg max-w-2xl mx-auto">
        {/* AQUÍ EL CAMBIO: Descripción dinámica */}
        {blok?.subtitle || "Algunos de los proyectos notables que he construido:"}
      </p>

      {/* BOTONES DE FILTRO */}
      <div class="grid grid-cols-2 gap-4 max-w-xs mx-auto mt-10 p-1.5 bg-slate-900/50 rounded-full border border-slate-800 backdrop-blur-sm">
        <button 
          class="filter-btn w-full py-2.5 rounded-full font-medium text-sm transition-all duration-300 bg-blue-600 text-white shadow-lg shadow-blue-900/20"
          data-filter="datos"
        >
          Datos
        </button>
        <button 
          class="filter-btn w-full py-2.5 rounded-full font-medium text-sm transition-all duration-300 text-slate-400 hover:text-white hover:bg-slate-800"
          data-filter="software"
        >
          Software
        </button>
      </div>
    </div>

    <div class="grid grid-cols-1 gap-12 max-w-6xl mx-auto" id="projects-grid">
      {
        projects && projects.length > 0 ? (
          projects.map((project:any, index:any) => {
              
              // --- 1. NORMALIZAMOS CATEGORÍA ---
              const categoriaRaw = project.category || project.content?.category || "General"; 
              const categoria = categoriaRaw.toLowerCase().trim();
              
              // --- 2. RECUPERAMOS TAGS (Corrección importante) ---
              // Buscamos en 'technologies' O en 'tags'.
              let rawTags = project.technologies || project.content?.technologies || project.tags || project.content?.tags || [];
              let tags = [];

              if (typeof rawTags === 'string') {
                  // Si es texto "React, Astro", lo convertimos a array
                  tags = rawTags.split(',').map(t => t.trim());
              } else if (Array.isArray(rawTags)) {
                  // Si ya es array, lo usamos directo
                  tags = rawTags;
              }

              // --- 3. LÓGICA ZIG ZAG ---
              const isReversed = index % 2 !== 0;

              // Filtro inicial (para renderizado del servidor)
              const isVisible = categoria === DEFAULT_FILTER;

              return (
                <article 
                  class={`project-card group relative bg-[#111827] rounded-2xl overflow-hidden border border-slate-800 hover:border-blue-500/50 transition-all duration-500 flex flex-col md:flex-row h-auto md:h-[350px] ${isVisible ? '' : 'hidden'} ${isReversed ? 'md:flex-row-reverse' : ''}`}
                  data-category={categoria} 
                  style={isVisible ? 'opacity: 1; transform: translateY(0);' : 'opacity: 0; transform: translateY(20px);'}
                >
                  
                  {/* IMAGEN - 55% ancho y SIEMPRE h-full */}
                  <div class="w-full md:w-[55%] h-64 md:h-full relative overflow-hidden bg-slate-900">
                    <div class="absolute inset-0 bg-blue-900/10 group-hover:bg-transparent transition-colors duration-500 z-10"></div>
                    <img 
                      src={project.image?.filename || project.image || "/placeholder.jpg"} 
                      alt={project.title} 
                      class="w-full h-full object-cover object-center transform group-hover:scale-105 transition-transform duration-700 ease-out"
                    />
                  </div>

                  {/* CONTENIDO - 45% ancho */}
                  <div class="w-full md:w-[45%] p-8 md:p-10 flex flex-col justify-center relative z-20 h-full">
                    
                    <h3 class="text-2xl md:text-3xl font-bold text-white mb-4 group-hover:text-blue-400 transition-colors">
                      {project.title}
                    </h3>
                    
                    <p class="text-slate-400 mb-8 leading-relaxed text-base line-clamp-4 md:line-clamp-5">
                      {project.description}
                    </p>

                    {/* TAGS (Iteramos sobre el array procesado arriba) */}
                    <div class="flex flex-wrap gap-2 mb-8">
                      {tags.map((tag:string) => (
                        <span class="px-3 py-1 text-xs font-medium text-blue-200 bg-blue-900/30 rounded-full border border-blue-900/50">
                          {tag}
                        </span>
                      ))}
                    </div>

                    <a 
                      href={project.link?.url || project.link || "#"} 
                      target="_blank" 
                      rel="noopener noreferrer"
                      class="inline-flex items-center text-white hover:text-blue-400 font-semibold transition-colors gap-2 group/link mt-auto md:mt-0"
                    >
                      <span>Ver Proyecto</span>
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform group-hover/link:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                      </svg>
                    </a>
                  </div>

                </article>
              )
          })
        ) : (
          <div class="text-center text-slate-500 p-10 bg-slate-800/50 rounded-xl border border-slate-700">
             <p>No se encontraron proyectos cargados.</p>
          </div>
        )
      }
    </div>

    <div id="no-projects" class="hidden text-center text-slate-500 mt-20">
        <p class="text-lg">No hay proyectos en esta categoría todavía.</p>
    </div>

  </div>
</section>

<script>
  document.addEventListener('astro:page-load', () => {
    
    const buttons = document.querySelectorAll('.filter-btn');
    const cards = document.querySelectorAll('.project-card');
    const noProjectsMsg = document.getElementById('no-projects');

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        // 1. ESTILOS BOTONES
        buttons.forEach(b => {
            b.classList.remove('bg-blue-600', 'text-white', 'shadow-lg');
            b.classList.add('text-slate-400', 'hover:text-white');
        });
        
        // Estilo activo
        btn.classList.remove('text-slate-400', 'hover:text-white', 'hover:bg-slate-800');
        btn.classList.add('bg-blue-600', 'text-white', 'shadow-lg');

        // 2. LÓGICA FILTRADO
        const filterAttr = btn.getAttribute('data-filter');
        const filterValue = filterAttr ? filterAttr.toLowerCase().trim() : '';
        let visibleCount = 0;

        cards.forEach((cardElement) => {
          const card = cardElement;
          if (!(card instanceof HTMLElement)) return;

          const cardCategory = card.getAttribute('data-category');

          if (cardCategory === filterValue) {
            // MOSTRAR
            card.classList.remove('hidden');
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 50);
            visibleCount++;
          } else {
            // OCULTAR
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            setTimeout(() => {
                card.classList.add('hidden');
            }, 500);
          }
        });

        // 3. MENSAJE VACÍO
        setTimeout(() => {
            if (visibleCount === 0 && noProjectsMsg) {
                noProjectsMsg.classList.remove('hidden');
            } else if (noProjectsMsg) {
                noProjectsMsg.classList.add('hidden');
            }
        }, 500);
      });
    });
  });
  
  // Disparador inicial por si no usas ViewTransitions
  document.dispatchEvent(new Event('astro:page-load'));
</script>

<style>
  .hidden {
    display: none !important;
  }
</style>